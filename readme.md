
# 3Commas API Integration - Full Issue Summary and Setup Guide

## Overview
This project integrates with the 3Commas API to create smart trades using signed API requests.  
The API requires requests to be signed using HMAC SHA256 to verify authenticity.

---

## Setup & Usage

- Create a `.env` file in your project root with your API credentials:
  ```
  API_KEY=your_3commas_api_key
  API_SECRET=your_3commas_secret_key
  ```
- Run the Node.js server with:
  ```bash
  node server.js
  ```
- The server listens on port `5000` and exposes the POST endpoint `/create-smarttrade`.


  - Run the Node.js old version server with:
  ```bash
  node index.js
  ```
- The server listens on port `5000` and exposes the POST endpoint `/smart-trade/create`.

---

## How Signature Works

1. **Signing Data Construction:**

   Signature is generated by concatenating:
   ```
   <request_path_and_query_string> + <request_body>
   ```
   For example:
   ```
   /public/api/ver1/users/change_mode?mode=paper
   ```
   (if no request body, just path+query string)

2. **Generate HMAC SHA256 signature:**

   Use your **secret key** and sign the above concatenated string.

3. **Send API request with headers:**

   ```
   APIKEY: your_api_key
   Signature: generated_signature
   ```

---

## Common Issues & Solutions

### 1. `Cannot POST /create-smarttrade`

- **Cause:** Route missing or server not running.
- **Fix:** Make sure Express POST route is set and server is running on correct port.

---

### 2. `"access_denied" - IP address is not allowed`

- **Cause:** API key restricted to certain IPs.
- **Fix:**  
  - Remove IP restrictions from your API key in 3Commas dashboard or  
  - Add your server's IP to the allowed list.

---

### 3. `"signature_invalid" - Provided signature is invalid`

- **Cause:** Signature generated incorrectly.
- **Fix:**
  - Ensure signature string = `<path_and_query_string> + <request_body>`.
  - Use the exact raw JSON string sent in the request as body.
  - Use your secret key for HMAC SHA256.
  - Hex encode the signature.
  - Match exact HTTP method, path, query and body as signed.
  
---

### 4. `"Forbidden" - Account not owned by current user` (HTTP 403)

- **Cause:** The `account_id` in the payload is not linked to your API key.
- **Fix:**
  - Fetch the list of your accounts with the API using your key.
  - Use a valid `account_id` from the returned accounts.
  
---

## Example Node.js Server Code (Express)

```js
const express = require('express');
const axios = require('axios');
const crypto = require('crypto');
require('dotenv').config();

const app = express();
const PORT = 5000;

// Capture raw body for signature generation
app.use(express.json({
  verify: (req, res, buf) => {
    req.rawBody = buf.toString('utf8');
  }
}));

app.post('/create-smarttrade', async (req, res) => {
  try {
    const path = '/public/api/v2/smart_trades';  // API endpoint path
    const rawBody = req.rawBody;                  // Raw JSON string of request body
    const apiSecret = process.env.API_SECRET;
    const apiKey = process.env.API_KEY;

    // Construct string to sign: path + body
    const payloadToSign = path + rawBody;

    // Generate signature with HMAC SHA256
    const signature = crypto
      .createHmac('sha256', apiSecret)
      .update(payloadToSign)
      .digest('hex');

    // Make the signed request to 3Commas API
    const response = await axios.post(
      'https://api.3commas.io' + path,
      JSON.parse(rawBody),
      {
        headers: {
          'APIKEY': apiKey,
          'Signature': signature,
          'Content-Type': 'application/json'
        }
      }
    );

    res.json(response.data);
  } catch (error) {
    console.error('Error:', error.response?.data || error.message);
    res.status(error.response?.status || 500).json(error.response?.data || { message: error.message });
  }
});

app.listen(PORT, () => {
  console.log(`âœ… Server running at http://localhost:${PORT}`);
});
```

---

## Testing Signature Locally with OpenSSL

You can test signature generation like this:

```bash
echo -n "/public/api/ver1/users/change_mode?mode=paper" | openssl dgst -sha256 -hmac "YOUR_SECRET_KEY"
```

Make sure your signature matches what you generate in code.

---

## Tips for Debugging

- Always log your raw request body and the string you sign.
- Verify your request body JSON matches exactly what you signed.
- Use Postman to test requests before implementing in code.
- Ensure your API key has proper permissions enabled.
- Fetch and verify your account IDs before using them.
- Read the official 3Commas API docs carefully for signature instructions.

---

## Resources

- [3Commas API Documentation](https://3commas.io/api-documentation)
- [Node.js Crypto Module](https://nodejs.org/api/crypto.html)
- [HMAC SHA256 Algorithm](https://en.wikipedia.org/wiki/HMAC)

---

**Author:** Fahim Montasir Turza  
**Date:** 2025-05-20
